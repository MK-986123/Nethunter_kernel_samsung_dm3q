name: Kernel Build

on:
  push:
    branches:
      - WIP  # Triggers the action on pushes to the WIP branch
  pull_request:
    branches:
      - WIP  # Optionally build on pull requests to the WIP branch

jobs:
  build:
    runs-on: ubuntu-latest  # The environment to run on (Ubuntu)

    steps:
    - name: Checkout Nethunter kernel source
      uses: actions/checkout@v3
      with:
        repository: MK-986123/Nethunter_kernel_samsung_dm3q
        ref: WIP

    - name: Checkout AnyKernel3 source
      uses: actions/checkout@v3
      with:
        repository: HardcodedCat/AnyKernel3
        ref: WIP
        path: AnyKernel3

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang llvm lld git bc bison flex libncurses5-dev curl zip

    - name: Build the kernel
      run: |
        # Export environment variables
        export ARCH=arm64
        export KERNEL_SOURCE=https://github.com/MK-986123/Nethunter_kernel_samsung_dm3q
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CLANG_PATH=$(pwd)/clang/bin
        export PATH=$CLANG_PATH:$PATH

        # Clean any previous build artifacts
        make clean && make mrproper

        # Build the kernel using the specified config
        make kalama-gki_defconfig O=out
        make -j$(nproc) CC=clang LD=ld.lld KBUILD_COMPILER_STRING="Clang $(clang --version)" O=out

    - name: Package the kernel with AnyKernel3
      run: |
        # Copy compiled kernel to AnyKernel3 directory
        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        
        # Create a flashable zip
        cd AnyKernel3
        zip -r9 kernel.zip ./*
        cd ..

    - name: Upload kernel.zip artifact
      uses: actions/upload-artifact@v3
      with:
        name: kernel.zip
        path: AnyKernel3/kernel.zip
